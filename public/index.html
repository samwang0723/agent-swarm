<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Swarm</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: calc(var(--vh, 1vh) * 100);
        line-height: 1.6;
        box-sizing: border-box;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        height: calc(calc(var(--vh, 1vh) * 100) - 40px);
        max-height: calc(calc(var(--vh, 1vh) * 100) - 40px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      h1 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.8rem;
        flex-shrink: 0;
      }

      .chat-container {
        flex: 1 1 0;
        overflow-y: auto;
        border: 1px solid #e1e8ed;
        padding: 20px;
        margin: 10px 0 20px 0;
        background: #fafbfc;
        border-radius: 10px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        scroll-behavior: smooth;
        min-height: 0;
      }

      .chat-container::-webkit-scrollbar {
        width: 6px;
      }

      .chat-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      .chat-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      .chat-container::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }

      .message {
        margin: 15px 0;
        padding: 16px 20px;
        border-radius: 18px;
        max-width: 85%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease-out;
        position: relative;
        line-height: 1.5;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .assistant-message {
        background: white;
        color: #2c3e50;
        margin-right: auto;
        border: 1px solid #e1e8ed;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 8px;
        text-align: right;
      }

      .user-message .message-time {
        color: rgba(255, 255, 255, 0.8);
      }

      .assistant-message .message-time {
        color: #8492a6;
        text-align: left;
      }

      .input-container {
        display: flex;
        gap: 12px;
        align-items: center;
        background: white;
        padding: 8px;
        border-radius: 15px;
        border: 2px solid #e1e8ed;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        flex-shrink: 0;
      }

      .input-container:focus-within {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      textarea {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
        background: transparent;
        resize: none;
        min-height: 20px;
        max-height: 120px;
        line-height: 1.4;
        font-family: inherit;
        overflow-y: auto;
        transition: height 0.2s ease;
      }

      textarea::-webkit-scrollbar {
        width: 4px;
      }

      textarea::-webkit-scrollbar-track {
        background: transparent;
      }

      textarea::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 2px;
      }

      button {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      /* Icon buttons in input container */
      #sendBtn {
        width: 36px;
        height: 36px;
        min-width: 36px;
        padding: 0;
        margin-right: 10px;
        font-size: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        background: #e2e8f0;
        color: #a0aec0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0 10px 0;
        flex-wrap: wrap;
        gap: 10px;
        flex-shrink: 0;
      }

      .status {
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        flex: 1;
        min-width: 200px;
      }

      .status.info {
        background: #e6f3ff;
        color: #0369a1;
        border: 1px solid #bae6fd;
      }

      .status.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .status.success {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #bbf7d0;
      }

      .latency-indicator {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
        white-space: nowrap;
      }

      .latency-indicator.fast {
        background: #f0fdf4;
        border-color: #bbf7d0;
        color: #16a34a;
      }

      .latency-indicator.slow {
        background: #fef3c7;
        border-color: #fcd34d;
        color: #d97706;
      }

      .latency-indicator.very-slow {
        background: #fef2f2;
        border-color: #fecaca;
        color: #dc2626;
      }

      .typing-indicator {
        color: #8492a6;
        font-style: italic;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Markdown formatting styles with better spacing */
      .message h1,
      .message h2,
      .message h3,
      .message h4,
      .message h5,
      .message h6 {
        margin: 1em 0 0.5em 0;
        font-weight: 600;
        line-height: 1.3;
      }

      .message h1 {
        font-size: 1.5em;
      }
      .message h2 {
        font-size: 1.3em;
      }
      .message h3 {
        font-size: 1.1em;
      }
      .message h4,
      .message h5,
      .message h6 {
        font-size: 1em;
      }

      .message code {
        background: rgba(0, 0, 0, 0.1);
        padding: 3px 6px;
        border-radius: 4px;
        font-family:
          'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas,
          'Courier New', monospace;
        font-size: 0.9em;
      }

      .message pre {
        background: rgba(0, 0, 0, 0.08);
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 16px 0;
        border-left: 4px solid #667eea;
      }

      .message pre code {
        background: none;
        padding: 0;
      }

      .message blockquote {
        border-left: 4px solid #667eea;
        margin: 16px 0;
        padding: 8px 0 8px 16px;
        color: #64748b;
        font-style: italic;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 0 8px 8px 0;
      }

      .message ul,
      .message ol {
        margin: 16px 0;
        padding-left: 24px;
      }

      .message li {
        margin: 8px 0;
        line-height: 1.6;
      }

      .message table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .message th,
      .message td {
        border: 1px solid #e2e8f0;
        padding: 12px 16px;
        text-align: left;
      }

      .message th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
      }

      .message strong {
        font-weight: 600;
        color: #374151;
      }

      .message em {
        font-style: italic;
        color: #64748b;
      }

      .message a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
      }

      .message a:hover {
        text-decoration: underline;
      }

      .message hr {
        border: none;
        border-top: 2px solid #e2e8f0;
        margin: 24px 0;
        border-radius: 1px;
      }

      .message img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 8px 0;
      }

      .message p {
        margin: 12px 0;
        line-height: 1.7;
      }

      .message p:first-child {
        margin-top: 0;
      }

      .message p:last-child {
        margin-bottom: 0;
      }

      /* Special styling for user messages with markdown */
      .user-message code {
        background: rgba(255, 255, 255, 0.25);
      }

      .user-message pre {
        background: rgba(255, 255, 255, 0.15);
        border-left-color: rgba(255, 255, 255, 0.5);
      }

      .user-message blockquote {
        border-left-color: rgba(255, 255, 255, 0.5);
        color: rgba(255, 255, 255, 0.9);
        background: rgba(255, 255, 255, 0.1);
      }

      .user-message th {
        background: rgba(255, 255, 255, 0.2);
      }

      .user-message a {
        color: #fff;
        font-weight: 600;
      }

      .user-message strong {
        color: #fff;
      }

      .user-message em {
        color: rgba(255, 255, 255, 0.9);
      }

      /* Link Preview Styles */
      .link-preview {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin: 12px 0;
        overflow: hidden;
        background: #e2e8f0;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .link-preview:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
      }

      .link-preview-content {
        padding: 12px;
        display: flex;
        gap: 12px;
      }

      .link-preview-image {
        width: 80px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .link-preview-text {
        flex: 1;
        min-width: 0;
      }

      .link-preview-title {
        font-weight: 600;
        font-size: 14px;
        color: #2c3e50;
        margin: 0 0 4px 0;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .link-preview-description {
        font-size: 12px;
        color: #64748b;
        margin: 0 0 4px 0;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .link-preview-url {
        font-size: 11px;
        color: #94a3b8;
        text-decoration: none;
        font-family: 'SF Mono', Monaco, monospace;
      }

      .link-preview-loading {
        padding: 12px;
        text-align: center;
        color: #64748b;
        font-size: 12px;
        font-style: italic;
      }

      /* User message link previews */
      .user-message .link-preview {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .user-message .link-preview:hover {
        border-color: rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.2);
      }

      .user-message .link-preview-title {
        color: white;
      }

      .user-message .link-preview-description {
        color: rgba(255, 255, 255, 0.8);
      }

      .user-message .link-preview-url {
        color: rgba(255, 255, 255, 0.7);
      }

      /* Header Styles */
      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        margin-bottom: 0px;
        border-bottom: 1px solid #e2e8f0;
        flex-shrink: 0;
      }

      .auth-controls {
        display: flex;
        align-items: center;
      }

      #loginSection,
      #userSection {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .google-login-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: #fff;
        color: #333;
        border: 1px solid #dadce0;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      .google-login-btn:hover {
        background: #f8f9fa;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
      }

      .google-login-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .google-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .user-info-compact {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        border: 1px solid #e1e8ed;
        color: #2c3e50;
        font-size: 13px;
        transition: all 0.3s ease;
        margin-right: 12px;
      }

      .user-info-compact:hover {
        border-color: #667eea;
        background: rgba(255, 255, 255, 0.95);
      }

      .user-details {
        flex: 1;
        min-width: 0;
      }

      #userName {
        color: #2c3e50 !important;
        font-weight: 600 !important;
        font-size: 14px !important;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 1.2;
        margin-bottom: 2px;
      }

      #userEmail {
        color: #64748b !important;
        font-weight: 400 !important;
        font-size: 12px !important;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 1.2;
        opacity: 0.8;
      }

      .control-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }

      .action-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        min-width: 60px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .action-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .action-btn:disabled {
        background: #e2e8f0;
        color: #a0aec0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .logout-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        min-width: 60px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid #e1e8ed;
        flex-shrink: 0;
        transition: all 0.3s ease;
        background: #f8fafc;
        object-fit: cover;
        opacity: 0;
        animation: fadeIn 0.3s ease-out forwards;
      }

      .user-avatar:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      /* Loading state for avatar */
      .user-avatar.loading {
        opacity: 0.5;
        animation: pulse 1.5s infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        body {
          padding: 20px;
        }

        .container {
          padding: 20px;
        }

        .header-section {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          min-height: auto;
        }

        h1 {
          text-align: left;
          font-size: 1.2rem;
          flex-shrink: 1;
          margin: 0;
        }

        .auth-controls {
          justify-content: center;
        }

        .user-info-compact {
          margin-right: 8px;
          padding: 6px 10px;
        }

        .control-buttons {
          gap: 6px;
        }

        .action-btn,
        .logout-btn {
          padding: 6px 12px;
          font-size: 12px;
          min-width: 55px;
          height: 32px;
        }

        .status-container {
          margin: 16px 0 8px 0;
        }

        .input-container {
          padding: 6px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 15px;
        }

        .container {
          padding: 15px;
        }

        .header-section {
          gap: 8px;
        }

        h1 {
          font-size: 1.1rem;
        }

        .user-info-compact {
          padding: 4px 8px;
          margin-right: 4px;
        }

        .user-avatar {
          width: 28px;
          height: 28px;
        }

        .action-btn,
        .logout-btn {
          padding: 4px 8px;
          font-size: 11px;
          min-width: 50px;
          height: 28px;
        }

        .control-buttons {
          gap: 4px;
        }

        .google-login-btn {
          padding: 8px 16px;
          font-size: 13px;
        }

        .status-container {
          margin: 12px 0 6px 0;
        }

        .input-container {
          padding: 4px;
        }

        .container {
          height: calc(calc(var(--vh, 1vh) * 100) - 30px);
          max-height: calc(calc(var(--vh, 1vh) * 100) - 30px);
        }

        .message {
          max-width: 95%;
          padding: 10px 14px;
        }
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header with Title and Authentication -->
      <header class="header-section" id="authSection">
        <h1>Agent Swarm</h1>

        <div class="auth-controls">
          <div id="loginSection">
            <button
              onclick="loginWithGoogle()"
              class="google-login-btn"
              id="googleLoginBtn"
            >
              <svg class="google-icon" viewBox="0 0 24 24">
                <path
                  fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Sign in
            </button>
          </div>

          <div id="userSection" class="hidden">
            <div class="user-info-compact">
              <img
                id="userAvatar"
                class="user-avatar"
                src=""
                alt="User Avatar"
              />
              <div class="user-details">
                <div id="userName"></div>
                <div id="userEmail"></div>
              </div>
            </div>
            <div class="control-buttons">
              <button onclick="clearHistory()" id="clearBtn" class="action-btn">
                Clear
              </button>
              <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
          </div>
        </div>
      </header>

      <div class="status-container">
        <div class="status info" id="status">
          Please sign in to start chatting.
        </div>
        <div
          class="latency-indicator"
          id="latencyIndicator"
          style="display: none"
        >
          ⚡ 0ms
        </div>
      </div>

      <div class="chat-container" id="chatContainer"></div>

      <div class="input-container">
        <textarea
          id="messageInput"
          placeholder="Type your message..."
          disabled
          rows="1"
        ></textarea>
        <button
          onclick="sendMessage()"
          id="sendBtn"
          disabled
          title="Send message"
        >
          ➤
        </button>
      </div>
    </div>

    <script>
      let isStreaming = false;
      let messageStartTime = null;
      let currentUser = null;

      async function handleAuthError(response) {
        let message = 'Authentication failed. Please sign in again.';
        if (response.status === 401) {
          try {
            const errorData = await response.json();
            if (errorData.code === 'REFRESH_TOKEN_ERROR') {
              message = 'Session expired. Please sign in again.';
            } else if (errorData.message) {
              message = errorData.message;
            }
          } catch (e) {
            // ignore if response is not json
          }
        }
        updateStatus(message, 'error');
        currentUser = null;
        updateAuthUI();
        document.getElementById('messageInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
      }

      // Function to handle viewport height on mobile
      function setViewportHeight() {
        // We are using a CSS variable --vh to set the viewport height.
        // This is to avoid issues on mobile browsers where 100vh includes the URL bar.
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }

      // Set the height on load, resize, and orientation change
      window.addEventListener('resize', setViewportHeight);
      window.addEventListener('orientationchange', setViewportHeight);
      setViewportHeight();

      // URL detection regex
      const urlRegex =
        /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/gi;

      // Authentication functions
      async function loginWithGoogle() {
        try {
          updateStatus('Redirecting to Google...', 'info');
          window.location.href = '/api/v1/auth/google';
        } catch (error) {
          updateStatus(`Login error: ${error.message}`, 'error');
        }
      }

      async function logout() {
        try {
          updateStatus('Logging out...', 'info');
          const response = await fetch('/api/v1/auth/logout', {
            method: 'POST',
            credentials: 'include',
          });

          if (response.ok) {
            currentUser = null;
            updateAuthUI();
            updateStatus('Logged out successfully', 'success');

            // Clear chat
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('latencyIndicator').style.display = 'none';
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
          } else {
            throw new Error('Logout failed');
          }
        } catch (error) {
          updateStatus(`Logout error: ${error.message}`, 'error');
        }
      }

      async function checkAuthStatus() {
        try {
          console.log('=== AUTH CHECK DEBUG ===');
          const response = await fetch('/api/v1/auth/me', {
            credentials: 'include',
          });

          console.log('Auth response status:', response.status);
          console.log('Auth response ok:', response.ok);

          if (response.ok) {
            const userData = await response.json();
            console.log(
              'Raw user data from /me endpoint:',
              JSON.stringify(userData, null, 2)
            );

            currentUser = userData;
            updateAuthUI();
            updateStatus('Welcome back! Ready to chat.', 'success');

            // Enable chat controls when authenticated
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            // Pre-warm the swarm and load history concurrently
            await Promise.all([initializeSwarm(), loadChatHistory()]);
          } else {
            await handleAuthError(response);
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          currentUser = null;
          updateAuthUI();
          updateStatus('Please sign in to continue', 'info');

          // Disable chat controls on error
          document.getElementById('messageInput').disabled = true;
          document.getElementById('sendBtn').disabled = true;
        }
      }

      function updateAuthUI() {
        const loginSection = document.getElementById('loginSection');
        const userSection = document.getElementById('userSection');

        console.log('updateAuthUI called:', {
          currentUser: currentUser,
          loginSection: !!loginSection,
          userSection: !!userSection,
        });

        // Ensure DOM elements exist before proceeding
        if (!loginSection || !userSection) {
          console.warn('Auth UI elements not ready, retrying in 100ms');
          setTimeout(updateAuthUI, 100);
          return;
        }

        // Add detailed debugging for currentUser data
        if (currentUser) {
          console.log('=== USER DATA DEBUG ===');
          console.log(
            'Full currentUser object:',
            JSON.stringify(currentUser, null, 2)
          );
          console.log('currentUser.email:', currentUser.email);
          console.log('currentUser.picture:', currentUser.picture);
          console.log(
            'Email element exists:',
            !!document.getElementById('userEmail')
          );
          console.log(
            'Avatar element exists:',
            !!document.getElementById('userAvatar')
          );
        }

        if (currentUser) {
          console.log('User is authenticated, showing user section');
          // Show user info, hide login
          loginSection.classList.add('hidden');
          userSection.classList.remove('hidden');

          // Update user info - both name and email
          const nameElement = document.getElementById('userName');
          const emailElement = document.getElementById('userEmail');
          const avatarElement = document.getElementById('userAvatar');

          // Ensure elements exist before updating
          if (!nameElement || !emailElement || !avatarElement) {
            console.warn('User info elements not ready, retrying in 100ms');
            setTimeout(updateAuthUI, 100);
            return;
          }

          if (nameElement) {
            const displayName =
              currentUser.name || currentUser.email?.split('@')[0] || 'User';
            nameElement.textContent = displayName;
            console.log('Name element updated with:', displayName);
          } else {
            console.error('Name element not found!');
          }

          if (emailElement) {
            const displayEmail =
              currentUser.email || currentUser.id || 'No email available';
            emailElement.textContent = displayEmail;
            console.log('Email element updated with:', displayEmail);
          } else {
            console.error('Email element not found!');
          }

          if (avatarElement) {
            // Set up proper image loading with error handling
            const fallbackSvg =
              'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI4IiB5PSI4Ij4KPHBhdGggZD0iTTggMTJDMTAuMjA5MSAxMiAxMiAxMC4yMDkxIDEyIDhDMTIgNS43OTA5IDEwLjIwOTEgNCA4IDRDNS43OTA5IDQgNCA1Ljc5MDkgNCA4QzQgMTAuMjA5MSA1Ljc5MDkgMTIgOCAxMloiIGZpbGw9IndoaXRlIi8+CjwvZz4KPC9zdmc+';

            // Clear any existing error handlers
            avatarElement.onload = null;
            avatarElement.onerror = null;

            if (currentUser.picture && currentUser.picture.startsWith('http')) {
              // Show loading state
              avatarElement.classList.add('loading');

              // For external URLs, implement proper error handling
              avatarElement.onload = function () {
                console.log('Avatar loaded successfully:', currentUser.picture);
                this.classList.remove('loading');
              };

              avatarElement.onerror = function () {
                console.warn(
                  'Failed to load avatar, using fallback:',
                  currentUser.picture
                );
                this.onload = null;
                this.onerror = null;
                this.classList.remove('loading');
                this.src = fallbackSvg;
              };

              // Set a loading timeout as additional safety
              const loadTimeout = setTimeout(() => {
                if (
                  !avatarElement.complete ||
                  avatarElement.naturalHeight === 0
                ) {
                  console.warn('Avatar loading timeout, using fallback');
                  avatarElement.onload = null;
                  avatarElement.onerror = null;
                  avatarElement.classList.remove('loading');
                  avatarElement.src = fallbackSvg;
                }
              }, 5000); // 5 second timeout

              // Clear timeout if image loads successfully
              const originalOnload = avatarElement.onload;
              avatarElement.onload = function () {
                clearTimeout(loadTimeout);
                this.classList.remove('loading');
                if (originalOnload) originalOnload.call(this);
              };

              avatarElement.src = currentUser.picture;
            } else {
              // Use fallback for missing or non-http URLs
              avatarElement.classList.remove('loading');
              avatarElement.src = fallbackSvg;
            }

            console.log(
              'Avatar element updated with:',
              currentUser.picture ? 'picture URL' : 'fallback SVG'
            );
          } else {
            console.error('Avatar element not found!');
          }
        } else {
          console.log('User is not authenticated, showing login section');
          // Show login, hide user info
          loginSection.classList.remove('hidden');
          userSection.classList.add('hidden');
        }
      }

      function isAuthenticated() {
        return currentUser !== null;
      }

      function updateStatus(message, type = 'info') {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status ${type}`;
      }

      function updateLatency(ms) {
        const indicator = document.getElementById('latencyIndicator');
        indicator.textContent = `⚡ ${ms}ms`;
        indicator.style.display = 'block';

        // Update style based on latency
        indicator.className = 'latency-indicator';
        if (ms < 500) {
          indicator.classList.add('fast');
        } else if (ms < 2000) {
          indicator.classList.add('slow');
        } else {
          indicator.classList.add('very-slow');
        }
      }

      function parseMarkdown(content) {
        marked.setOptions({
          breaks: true,
          gfm: true,
          sanitize: false,
        });

        const html = marked.parse(content);
        return DOMPurify.sanitize(html);
      }

      function formatTime() {
        return new Date().toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function addMessage(content, isUser = false, isStreaming = false) {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${
          isUser ? 'user-message' : 'assistant-message'
        }`;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = formatTime();

        if (isStreaming) {
          messageDiv.id = 'streaming-message';
          if (content) {
            messageDiv.innerHTML =
              parseMarkdown(content) +
              '<span class="typing-indicator"> ●</span>';
          } else {
            messageDiv.innerHTML =
              '<span class="typing-indicator">Agent thinking ●</span>';
          }
        } else {
          messageDiv.innerHTML = parseMarkdown(content);
          messageDiv.appendChild(timeDiv);

          // Add link previews for completed messages
          if (!isStreaming) {
            addLinkPreviews(messageDiv, content);
          }
        }

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        return messageDiv;
      }

      function updateStreamingMessage(content) {
        const streamingDiv = document.getElementById('streaming-message');
        if (streamingDiv) {
          const timeDiv = document.createElement('div');
          timeDiv.className = 'message-time';
          timeDiv.textContent = formatTime();

          streamingDiv.innerHTML = parseMarkdown(content);
          streamingDiv.appendChild(timeDiv);
          streamingDiv.removeAttribute('id');

          // Check for links and add previews
          addLinkPreviews(streamingDiv, content);
        }
      }

      // Extract URLs from text
      function extractUrls(text) {
        const matches = text.match(urlRegex);
        if (!matches) return [];

        // Clean up URLs by removing trailing punctuation that's likely sentence punctuation
        const cleanedUrls = matches.map(url => {
          // Remove trailing punctuation that's commonly used in sentences
          // but preserve punctuation that might be part of the URL structure
          return url.replace(/[.,;!?)]+$/, '');
        });

        return [...new Set(cleanedUrls)]; // Remove duplicates
      }

      // Create link preview element
      function createLinkPreview(url, metadata) {
        const preview = document.createElement('div');
        preview.className = 'link-preview';
        preview.onclick = () => window.open(url, '_blank');

        if (metadata.error) {
          preview.innerHTML = `
            <div class="link-preview-content">
              <div class="link-preview-text">
                <div class="link-preview-title">Link Preview Unavailable</div>
                <div class="link-preview-description">Unable to fetch preview for this link</div>
                <div class="link-preview-url">${truncateUrl(url)}</div>
              </div>
            </div>
          `;
        } else {
          const title = sanitizeHtml(metadata.title) || 'No Title';
          const description = sanitizeHtml(metadata.description) || '';
          const truncatedUrl = truncateUrl(url);

          preview.innerHTML = `
            <div class="link-preview-content">
              ${metadata.image ? `<img src="${metadata.image}" alt="Preview" class="link-preview-image" onerror="this.style.display='none'" loading="lazy">` : ''}
              <div class="link-preview-text">
                <div class="link-preview-title">${title}</div>
                ${description ? `<div class="link-preview-description">${description}</div>` : ''}
                <div class="link-preview-url">${truncatedUrl}</div>
              </div>
            </div>
          `;
        }

        return preview;
      }

      // Helper function to sanitize HTML content
      function sanitizeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // Helper function to truncate URLs for display
      function truncateUrl(url) {
        try {
          const urlObj = new URL(url);
          const domain = urlObj.hostname.replace('www.', '');
          const path = urlObj.pathname + urlObj.search;

          if (path.length > 30) {
            return domain + path.substring(0, 27) + '...';
          }
          return domain + path;
        } catch (e) {
          return url.length > 50 ? url.substring(0, 47) + '...' : url;
        }
      }

      // Fetch link metadata using free public services
      async function fetchLinkMetadata(url) {
        console.log('Fetching metadata for:', url);
        const key = '6e77afbad6431f973c4a174201dc77a0';

        // Try LinkPreview.net free tier (1000 requests/month)
        try {
          // Using demo key - in production, sign up at linkpreview.net for your own key
          const linkPreviewResponse = await fetch(
            `https://api.linkpreview.net/?key=${key}&q=${encodeURIComponent(url)}`
          );
          console.log(
            'LinkPreview.net:',
            `https://api.linkpreview.net/?key=${key}&q=${encodeURIComponent(url)}`
          );
          console.log('LinkPreview.net response:', linkPreviewResponse);
          if (linkPreviewResponse.ok) {
            const linkData = await linkPreviewResponse.json();
            console.log('LinkPreview.net success');
            return {
              title: linkData.title || 'No Title',
              description: linkData.description || '',
              image: linkData.image || null,
              url: url,
            };
          }
        } catch (e) {
          console.log('LinkPreview.net failed:', e.message);
        }

        console.log('All methods failed, using fallback');
        // Final fallback with favicon
        return createFallbackMetadata(url);
      }

      // Create fallback metadata when fetching fails
      function createFallbackMetadata(url) {
        try {
          const urlObj = new URL(url);
          const domain = urlObj.hostname.replace('www.', '');

          return {
            title: `${domain.charAt(0).toUpperCase() + domain.slice(1)}`,
            description: `Visit ${domain}`,
            image: `https://www.google.com/s2/favicons?sz=64&domain=${domain}`,
            url: url,
          };
        } catch (e) {
          return {
            title: 'Link Preview',
            description: 'Click to visit',
            image: null,
            url: url,
          };
        }
      }

      // Add link previews to a message element
      async function addLinkPreviews(messageElement, content) {
        const urls = extractUrls(content).filter(url => {
          try {
            return !new URL(url).hostname.includes('ubereats.com');
          } catch (e) {
            // Keep urls that can't be parsed, they will be handled downstream
            return true;
          }
        });

        if (urls.length === 0) return;

        // Add loading indicators first
        urls.forEach(url => {
          const loadingPreview = document.createElement('div');
          loadingPreview.className = 'link-preview';
          loadingPreview.innerHTML =
            '<div class="link-preview-loading">Loading preview...</div>';
          messageElement.appendChild(loadingPreview);
        });

        // Fetch metadata for each URL
        for (let i = 0; i < urls.length; i++) {
          const url = urls[i];
          try {
            const metadata = await fetchLinkMetadata(url);
            const preview = createLinkPreview(url, metadata);

            // Replace loading indicator with actual preview
            const loadingElements =
              messageElement.querySelectorAll('.link-preview');
            if (loadingElements[i]) {
              messageElement.replaceChild(preview, loadingElements[i]);
            }
          } catch (error) {
            console.error('Error creating preview for:', url, error);
            // Replace with error preview
            const errorPreview = createLinkPreview(url, { error: true });
            const loadingElements =
              messageElement.querySelectorAll('.link-preview');
            if (loadingElements[i]) {
              messageElement.replaceChild(errorPreview, loadingElements[i]);
            }
          }
        }
      }

      async function initializeSwarm() {
        if (!isAuthenticated()) return;
        try {
          console.log('Pre-warming the agent swarm...');
          const response = await fetch('/api/v1/chat/init', {
            method: 'POST',
            credentials: 'include',
          });

          if (response.ok) {
            console.log('Swarm pre-warmed successfully.');
          } else {
            console.warn('Swarm pre-warming failed or was not needed.');
          }
        } catch (error) {
          console.error('Error during swarm pre-warming:', error);
        }
      }

      async function sendMessage() {
        if (isStreaming) return;

        // Check authentication
        if (!isAuthenticated()) {
          updateStatus('Please sign in to send messages', 'error');
          return;
        }

        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        // Record start time for latency measurement
        messageStartTime = performance.now();

        // Add user message to chat
        addMessage(message, true);
        input.value = '';
        autoResizeTextarea(input);

        // Disable controls during streaming
        isStreaming = true;
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('messageInput').disabled = true;

        updateStatus('Agent thinking...', 'info');

        try {
          // Create streaming message placeholder
          const streamingDiv = addMessage('', false, true);

          // Start streaming
          const response = await fetch('/api/v1/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ message }),
          });

          if (!response.ok) {
            await handleAuthError(response);
            return;
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let accumulatedText = '';

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.text) {
                    accumulatedText =
                      data.accumulated || accumulatedText + data.text;
                    streamingDiv.innerHTML =
                      parseMarkdown(accumulatedText) +
                      '<span class="typing-indicator"> ●</span>';

                    // Auto-scroll during streaming
                    const container = document.getElementById('chatContainer');
                    container.scrollTop = container.scrollHeight;
                  }
                  if (data.complete) {
                    // Calculate total response latency when complete
                    if (messageStartTime) {
                      const totalLatency = Math.round(
                        performance.now() - messageStartTime
                      );
                      updateLatency(totalLatency);
                    }
                    updateStreamingMessage(accumulatedText);
                  }
                } catch (e) {
                  // Ignore JSON parse errors from incomplete chunks
                }
              }
            }
          }

          updateStatus('Ready to chat!', 'success');
        } catch (error) {
          updateStatus(`Error: ${error.message}`, 'error');
          // Remove streaming placeholder on error
          const streamingDiv = document.getElementById('streaming-message');
          if (streamingDiv) streamingDiv.remove();
        } finally {
          // Re-enable controls
          isStreaming = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('messageInput').disabled = false;
          document.getElementById('messageInput').focus();
          messageStartTime = null;
        }
      }

      async function loadChatHistory() {
        if (!isAuthenticated()) {
          return;
        }

        try {
          const response = await fetch('/api/v1/chat/history', {
            credentials: 'include',
          });

          if (!response.ok) {
            await handleAuthError(response);
            return;
          }

          const historyData = await response.json();
          const chatContainer = document.getElementById('chatContainer');
          chatContainer.innerHTML = ''; // Clear before loading

          if (historyData.messages && historyData.messages.length > 0) {
            historyData.messages.forEach(msg => {
              // Do not display tool messages
              if (msg.role === 'tool') {
                return;
              }

              const isUser = msg.role === 'user';
              let content = msg.content;
              // Handle cases where content is an array of objects
              if (Array.isArray(content)) {
                content = content[0]?.text || '';
              }
              if (content === '') {
                return;
              }
              addMessage(content, isUser);
            });
            updateStatus('History restored.', 'success');
            // Scroll to bottom to show latest messages
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        } catch (error) {
          updateStatus(`Error loading history: ${error.message}`, 'error');
        }
      }

      async function clearHistory() {
        // Check authentication
        if (!isAuthenticated()) {
          updateStatus('Please sign in to clear history', 'error');
          return;
        }

        try {
          const response = await fetch('/api/v1/chat/history', {
            method: 'DELETE',
            credentials: 'include',
          });

          if (!response.ok) {
            await handleAuthError(response);
            return;
          }

          document.getElementById('chatContainer').innerHTML = '';
          document.getElementById('latencyIndicator').style.display = 'none';
          updateStatus('History cleared!', 'success');
        } catch (error) {
          updateStatus(`Error clearing history: ${error.message}`, 'error');
        }
      }

      // Auto-resize textarea function
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      }

      // Setup textarea auto-resize and keyboard handling
      document.addEventListener('DOMContentLoaded', function () {
        // Handle OAuth callback first
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auth') === 'success') {
          updateStatus('Successfully signed in!', 'success');
          // Clean up URL
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
          // Wait a bit longer for OAuth flow to complete
          setTimeout(() => {
            checkAuthStatus();
          }, 1000);
        } else if (urlParams.get('auth') === 'error') {
          updateStatus('Authentication failed. Please try again.', 'error');
          // Clean up URL
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
          // Still check auth status in case user is already logged in
          setTimeout(checkAuthStatus, 500);
        } else {
          // No OAuth callback, check auth status immediately
          checkAuthStatus();
        }

        const messageInput = document.getElementById('messageInput');

        // Auto-resize on input
        messageInput.addEventListener('input', function () {
          autoResizeTextarea(this);
        });

        // Handle Enter key (send message) and Shift+Enter (new line)
        messageInput.addEventListener('keydown', function (e) {
          if (
            e.key === 'Enter' &&
            !e.shiftKey &&
            !isStreaming &&
            isAuthenticated()
          ) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Reset height when input is cleared
        messageInput.addEventListener('blur', function () {
          if (!this.value.trim()) {
            this.style.height = 'auto';
          }
        });
      });
    </script>
  </body>
</html>
